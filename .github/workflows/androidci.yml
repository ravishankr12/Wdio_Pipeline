name: Android UI Tests

on: [push]

permissions:
  contents: read      # To read repo content (needed for checking out code and report generation)
  actions: read       # To read the action metadata and logs
  secrets: read       # To access secrets (like BS_USER and BS_KEY) for BrowserStack
  packages: write     # To upload artifacts, i.e., the zipped Allure report (if required)

jobs:
  build:
    runs-on: ubuntu-22.04  # âœ… Use stable runner

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.0

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Running npm install..."
          npm install
          echo "âœ… Dependencies installed."

      - name: ğŸ§ª Run Tests
        env:
          BS_USER: ${{ secrets.BS_USER }}
          BS_KEY: ${{ secrets.BS_KEY }}
        run: |
          echo "ğŸ§ª Starting tests with WebdriverIO..."
          npx wdio wdio.conf.js
          echo "âœ… Test run completed."

      - name: ğŸ“Š Generate Allure Report
        if: always()
        run: |
          echo "ğŸ“Š Generating Allure report..."
          npx allure generate allure-results --clean -o allure-report
          echo "ğŸ“ Allure report generated at: $(pwd)/allure-report"
          echo "ğŸ“„ HTML index: $(pwd)/allure-report/index.html"

      - name: ğŸ“‚ List Report Directory (Debug)
        if: always()
        run: |
          echo "ğŸ§¾ Listing contents of allure-report:"
          ls -R allure-report

      - name: ğŸ“¦ Zip Allure Report
        if: always()
        run: |
          zip -r allure-report.zip allure-report
          echo "ğŸ“¦ Zipped report ready: allure-report.zip"

      - name: â¬†ï¸ Upload Allure Report Artifact
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: allure-report
          path: allure-report.zip
